@using Markdig
@using Microsoft.JSInterop
@using MeshWeaver.Layout.Markdown
@inherits BlazorView<MarkdownControl, MarkdownView>
@inject IJSRuntime JsRuntime;
<div class="markdown">
@if(Html != null)
{
    @((MarkupString)Html) 
}


@foreach (var component in LayoutAreaComponents)
{
    <div id="@(ComponentContainerId(component.DivId))" style="display:none;">
        <LayoutArea Address="@Stream.Owner" Reference="@component.Reference" />
    </div>
}
</div>
@code 
{
    private IReadOnlyList<LayoutAreaComponentInfo> LayoutAreaComponents { get; set; } = [];
    private string Html { get; set; }
    protected override void BindData()
    {
        base.BindData();
        DataBind<string>(ViewModel.Data, RenderMarkdown);
    }

    private bool RenderMarkdown(string markdown)
    {
        var layoutAreaExtension = new LayoutAreaMarkdownExtension(Stream.Hub);
        var pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .Use(layoutAreaExtension)
            .Build();
        var newHtml = Markdown.ToHtml(markdown, pipeline);
        var newLayoutComponents = layoutAreaExtension.MarkdownParser.Areas;
        if (newHtml == Html && LayoutAreaComponents.SequenceEqual(newLayoutComponents))
            return false;
        Html = newHtml;
        LayoutAreaComponents = newLayoutComponents;
        return true;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.Import("basicBlazorInterop.js");

            foreach (var component in LayoutAreaComponents)
            {
                await JsRuntime.InvokeVoidAsync("interop.moveComponentToTarget", ComponentContainerId(component.DivId), component.DivId);
            }
        }
    }

    private string ComponentContainerId(string id) => $"component-container-{id}";
}