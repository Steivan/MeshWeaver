@using System.Reactive.Linq
@inherits BlazorView<ItemTemplateControl>

<FluentStack
    Class="@Class"
    Style="@Style">
    @for (int i=0;i<Data.Count;++i)
    {
        <DispatchView ViewModel="@GetViewWithPath(i)" Stream="@Stream" Area="@ViewArea" />
    }
</FluentStack>

@code
{
    private IReadOnlyCollection<object> Data { get; set; } = Array.Empty<object>();

    private UiControl view;

    private string ViewArea => $"{Area}/{ItemTemplateControl.ViewArea}";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        DataBind<IReadOnlyCollection<object>>(new JsonPointerReference(""), d => Data = d);
        view = GetControl(await Stream.FirstAsync(), ViewArea);
    }

    private UiControl GetViewWithPath(int i) => ViewModel.View with { DataContext = $"{ViewModel.DataContext}/{i}" };
}
