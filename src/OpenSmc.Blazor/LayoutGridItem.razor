@using System.Text.Json
@using OpenSmc.Data.Serialization
@inherits BlazorView<LayoutGridItemControl>

<FluentGridItem
    AdaptiveRendering="@ViewModel.AdaptiveRendering"
    Gap="@ViewModel.Gap"
    HiddenWhen="@HiddenWhen"
    Justify="@ViewModel.Justify?.ToFluentJustifyContent()"
    lg="@ViewModel.Lg"
    md="@ViewModel.Md"
    sm="@ViewModel.Sm"
    xl="@ViewModel.Xl"
    xs="@ViewModel.Xs"
    xxl="@ViewModel.Xxl"
    >
    <DispatchView ViewModel="@ContentViewModel" Stream="@Stream" Area="@ContentArea" />
</FluentGridItem>

@code
{
    UiControl ContentViewModel { get; set; }

    private string ContentArea => $"{Area}/ChildContent";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        Disposables.Add(Stream.Subscribe(item => InvokeAsync(() => Render(item)))); 
    }

    private void Render(ChangeItem<JsonElement> item)
    {
        ContentViewModel = GetControl(item, ContentArea);
        StateHasChanged();
    }

    private GridItemHidden HiddenWhen => ViewModel.HiddenWhen switch
    {
        LayoutGridItemHidden.Lg => GridItemHidden.Lg,
        LayoutGridItemHidden.LgAndDown => GridItemHidden.LgAndDown,
        LayoutGridItemHidden.LgAndUp => GridItemHidden.LgAndUp,
        LayoutGridItemHidden.Md => GridItemHidden.Md,
        LayoutGridItemHidden.Sm => GridItemHidden.Sm,
        LayoutGridItemHidden.Xl => GridItemHidden.Xl,
        LayoutGridItemHidden.Xs => GridItemHidden.Xs,
        LayoutGridItemHidden.XsAndDown => GridItemHidden.XsAndDown,
        LayoutGridItemHidden.XsAndUp => GridItemHidden.XsAndUp,
        LayoutGridItemHidden.Xxl => GridItemHidden.Xxl,
        LayoutGridItemHidden.XxlAndDown => GridItemHidden.XxlAndDown,
        LayoutGridItemHidden.XxlAndUp => GridItemHidden.XxlAndUp,
        LayoutGridItemHidden.SmAndDown => GridItemHidden.SmAndDown,
        LayoutGridItemHidden.SmAndUp => GridItemHidden.SmAndUp,
        LayoutGridItemHidden.MdAndDown => GridItemHidden.MdAndDown,
        LayoutGridItemHidden.MdAndUp => GridItemHidden.MdAndUp,
        LayoutGridItemHidden.XlAndDown => GridItemHidden.XlAndDown,
        LayoutGridItemHidden.XlAndUp => GridItemHidden.XlAndUp,
        _ => GridItemHidden.None
    };
}
