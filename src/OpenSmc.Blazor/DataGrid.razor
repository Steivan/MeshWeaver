@using System.Text.Json.Nodes
@using System.Text.Json
@using System.Linq.Expressions
@using OpenSmc.Layout.DataGrid
@inherits BlazorView<DataGridControl>

<FluentDataGrid Items="@QueryableData">
    @foreach (DataGridColumn column in ViewModel.Columns)
    {

        @((RenderFragment) (builder =>
        {
            builder.OpenComponent(0, typeof(PropertyColumn<,>).MakeGenericType(typeof(JsonObject), column.GetPropertyType()));
            var index = 0;
            builder.AddComponentParameter(++index, nameof(PropertyColumn<object,object>.Property), GetPropertyExpression((dynamic)column));
            builder.AddAttribute(++index, "Title", column.Title);
            if (!string.IsNullOrEmpty(column.Format))
                builder.AddAttribute(++index, nameof(PropertyColumn<object, object>.Format), column.Format);
            if (column.Sortable)
                builder.AddAttribute(++index, "Sortable", column.Sortable);

            builder.CloseComponent();
        }))

    }
</FluentDataGrid>

@code{
    private IQueryable<JsonObject> QueryableData {get;set;}

    private Expression<Func<JsonObject, T>> GetPropertyExpression<T>(DataGridColumn<T> column)
    {
        return e => e.ContainsKey(column.Property) ? e[column.Property].Deserialize<T>(Stream.Hub.JsonSerializerOptions) : default;
    }
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        DataBind<object>(ViewModel.Data, x => QueryableData = ((System.Collections.IEnumerable)x)?.Cast<JsonObject>().AsQueryable());
    }
}